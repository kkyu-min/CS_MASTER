# JVM의 구조와 Java의 실행방식을 설명해주세요

JAVA가 출시 이후에 많은 사랑을 받았던 이유는 운영체제(플랫폼)에 독립적이라는 점이었다.  
이를 가능하게 해주는 JVM에 대해서 알아보자.

### JVM (Java Virtual Machine)
JVM이란 자바 프로그램 실행 환경을 만들어 주는 소프트웨어다. 자바 코드를 컴파일하여 .class 바이트 코드로 만들면 이 코드가 JVM에서 실행 가능한 파일로 변환된다.  
자바는 C언어를 모태로 하기 때문에 상당히 유사하지만, JVM을 통해 각자의 플랫폼에 맞게 끔 컴파일을 따로 해줘야 할 필요가 없다는 점이 큰 차이이다.  
하지만 여기서 오해하면 안되는게, JAVA는 플랫폼에 종속적이지만 JVM은 플랫폼에 종속적이다. 즉, 윈도우용 JVM과 리눅스용 JVM 등등이 따로 존재한다.  
JVM은 JRE(Java Runtime Environment)에 포함되어 있다.

### 컴파일 방식
JVM은 바이트코드를 명령어 단위로 읽어서 해석한다. 이 때 Interpreter 방식과 JIT 컴파일 방식 두 가지 방식을 혼합하여 사용한다.

**Interpreter**  
바이트코드를 한 줄씩 해석, 실행하는 방식이다. 초기 방식으로, 속도가 느리다는 단점이 있다.

**JIT(Just In Time) 컴파일러**  
인터프리터 방식의 느린 속도를 보완하기 위해 등장하였다. 바이트 코드를 JIT 컴파일러를 이용해 프로그램을 실제 실행하는 시점 (바이트 코드를 실행하는 시점)에  
각 OS에 맞는 Native Code로 변환하여 실행 속도를 개선하였다. 하지만, 이러한 작업에도 상당한 비용이 소모되므로 모든 코드를 JIT 컴파일러 방식으로 실행하지 않고  
인터프리터 방식을 사용하다가 일정 기준이 넘어가면 JIT 컴파일 방식으로 명령어를 실행한다.

JIT 컴파일러는 같은 코드를 매번 해석하지 않고, 실행할 때 컴파일 하면서 해당 코드를 캐싱한다. 이후에는 바뀐 부분만 컴파일하고, 나머지는 캐싱된 코드를 사용한다.  
이러한 방식으로 이전의 인터프리터 방식보다 10~20배의 좋은 성능을 보인다.

### JVM의 동작 방식
1. 프로그램이 실행되면 JVM은 OS로부터 메모리를 할당받음
2. 자바 컴파일러(javac)가 자바 소스코드(.java)를 자바 바이트코드(.class)로 컴파일함\
3. Class Loader를 통해 JVM Runtime Data Area로 로딩함
4. Runtime Data Area에 로딩된 .class들은 Execution Engine을 통해 해석됨
5. 해석된 바이트코드는 Runtime Data Area의 각 영역에 배치되어 수행됨

## JVM의 구조

### Class Loader
컴파일된 .class 파일을 JVM위로 올리는 (Load) 작업을 수행함.

자바는 클래스 파일을 동적으로 읽어온다. JVM이 동작하다가 클래스 파일을 참조하는 순간 동적으로 읽어서 메모리에 로드되면서 JVM에 링크된다.  
자바 클래스 로더는 클래스들을 동적으로 메모리에 로딩하는 역할을 담당한다.

### 실행 엔진(Execution Engine)
JVM으로 로드된 .class 파일들은 Runtime Data Area의 Method Area에 배치되는데, 이후에 JVM은 Method Area의 바이트 코드를 실행 엔진에 제공하여 정의된 내용대로 바이트 코드를 실행시킨다.  
이 때, 로드된 바이트코드를 실행하는 런타임 모듈이 실행 엔진이다. 실행 엔진은 바이트코드를 명령어 단위로 읽어서 실행한다.

### GC

### 런타임 데이터 영역(Runtime Data Area)

런타임 데이터 영역은 JVM의 메모리 영역으로 자바 애플리케이션을 실행할 때 사용되는 데이터들을 적재하는 영역이다.

- 모든 스레드가 공유해서 사용(GC의 대상)
    - 힙(Heap Area)
    - 메소드(Method Area)
- 스레드 마다 하나씩 생성
    - 스택 영역(Stack Area)
    - PC 레지스터(PC Register)
    - 네이티브 메서드 스택(Native Method Stack)

**Method Area**
클래스 멤버 변수의 이름, 데이터 타입, 접근 제어자 정보와 같은 각종 필드 정보들과 메서드 정보, 데이터 타입, 상수풀, static 변수, final class 등이 생성되는 영역

**Heap Area**
new 키워드로 생성된 객체와 배열의 영역. GC가 빈번하게 발생하는 지역이다.  
Heap 영역은 Young Generation(Eden, Survivor), Old Generation(Tenured), Permanent Generation으로 나뉜다.

**Stack Area**
지역변수, 파라미터, 리턴 값, 임시 값 등이 생성되는 영역.

**PC Register**
스레드가 생성될 때 마다 생성되는 영역으로 프로그램 카운터, 즉 현재 스레드가 실행되는 부분의 주소와 명령을 저장하고 있는 영역.

**Native Method Stack**
1. 자바 이외의 언어로 작성된 네이티브 코드를 실행할 때 사용되는 메모리 영역으로 일반적인 C 스택을 사용함.
2. 보통 C, C++ 등의 코드를 수행하기 위한 스택을 말하며 자바 컴파일러에 의해 변환된 자바 바이트 코드를 읽고 해석하는 역할을 하는 것이 자바 인터프리터이다.

